---
phase: 02-core-quiz-flow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/mobile/app/quiz/index.tsx
  - apps/mobile/components/quiz/OptionButton.tsx
  - apps/mobile/components/quiz/QuizHeader.tsx
autonomous: true

must_haves:
  truths:
    - "Quiz session state persists if app is killed mid-quiz"
    - "Correct answer triggers checkmark scale-in animation"
    - "Progress bar pulses on each correct answer"
    - "Light haptic on option tap, success haptic on correct, error haptic on wrong"
    - "Exit confirmation modal prevents accidental progress loss"
    - "Answer options scale to 0.95 on press with spring bounce back"
  artifacts:
    - path: "apps/mobile/app/quiz/index.tsx"
      provides: "Quiz screen using Zustand quizStore"
      contains: "useQuizStore"
    - path: "apps/mobile/components/quiz/OptionButton.tsx"
      provides: "Checkmark scale-in animation for correct state, 0.95 press scale"
      contains: "checkmarkScale"
    - path: "apps/mobile/components/quiz/QuizHeader.tsx"
      provides: "Progress bar pulse animation"
      contains: "pulseScale"
  key_links:
    - from: "apps/mobile/app/quiz/index.tsx"
      to: "apps/mobile/stores/quizStore.ts"
      via: "useQuizStore hook"
      pattern: "useQuizStore\\(\\)"
    - from: "apps/mobile/app/quiz/index.tsx"
      to: "apps/mobile/components/quiz/QuizHeader.tsx"
      via: "shouldPulse prop based on lastAnswerCorrect state"
      pattern: "shouldPulse.*lastAnswerCorrect"
---

<objective>
Connect quiz flow to Zustand state management and complete animation polish

Purpose: Enable quiz session persistence and add the satisfying micro-animations that make the quiz feel premium (Duolingo-level polish)
Output: Quiz screen using Zustand with checkmark and progress pulse animations
</objective>

<execution_context>
@/Users/williamlarsten/.claude/get-shit-done/workflows/execute-plan.md
@/Users/williamlarsten/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-quiz-flow/02-CONTEXT.md
@.planning/phases/02-core-quiz-flow/02-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md

# Key files to reference
@apps/mobile/app/quiz/index.tsx
@apps/mobile/components/quiz/OptionButton.tsx
@apps/mobile/components/quiz/QuizHeader.tsx
@apps/mobile/components/quiz/ExitModal.tsx
@apps/mobile/stores/quizStore.ts
@apps/mobile/stores/progressStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Connect quiz screen to Zustand quizStore</name>
  <files>apps/mobile/app/quiz/index.tsx</files>
  <action>
Refactor quiz/index.tsx to use quizStore instead of local useState:

1. Import and use the quizStore:
   - Import: `import { useQuizStore } from '@/stores/quizStore'`
   - Get state: `const { currentQuestionIndex, answers, currentQuestions, startSession, submitAnswer, nextQuestion } = useQuizStore()`

2. On mount, check if session exists (for resume capability):
   - If `currentQuestions.length > 0` and `sessionStartTime !== null`, resume session
   - Otherwise, call `startSession(loadedQuestions, section)` with fresh questions

3. Replace local state management:
   - Remove: `const [currentIndex, setCurrentIndex] = useState(0)`
   - Remove: `const [answers, setAnswers] = useState<AnswerRecord[]>([])`
   - Use store's `currentQuestionIndex` and `answers` instead
   - Replace `setCurrentIndex(prev => prev + 1)` with `nextQuestion()`
   - Replace answer recording with `submitAnswer(newAnswer)`

4. Keep local UI state (phase, selectedOption, showExitModal) as local useState - these don't need persistence

5. Update handleContinue to work with store state for navigation params

6. Add local state for tracking last answer correctness (for pulse animation):
   ```typescript
   const [lastAnswerCorrect, setLastAnswerCorrect] = useState(false);
   ```
   Set this in handleCheckAnswer after determining isCorrect:
   ```typescript
   setLastAnswerCorrect(isCorrect);
   ```
   Reset it when moving to next question:
   ```typescript
   // In handleContinue, after incrementing question:
   setLastAnswerCorrect(false);
   ```

7. Pass `shouldPulse={lastAnswerCorrect}` to QuizHeader component

WHY this matters: Session persistence across app restarts. If user kills app mid-quiz, they resume where they left off (a Duolingo hallmark).
  </action>
  <verify>
1. `bun run lint` passes in apps/mobile
2. App builds: `cd apps/mobile && npx expo run:ios --no-build-cache` (or verify existing build works)
3. Programmatic verification of persistence:
   - Start quiz, answer 2 questions
   - In React Native debugger or via console, verify: `useQuizStore.getState().currentQuestionIndex === 2`
   - Kill app via Xcode/simulator, reopen
   - Verify: `useQuizStore.getState().currentQuestionIndex === 2` (still persisted)
4. Manual verification: Kill app mid-quiz, reopen - quiz should resume at same question
  </verify>
  <done>Quiz screen uses quizStore for questions/answers/index, session survives app restart, lastAnswerCorrect state tracks for pulse animation</done>
</task>

<task type="auto">
  <name>Task 1.5: Adjust press animation scale to 0.95 per ANIM-01</name>
  <files>apps/mobile/components/quiz/OptionButton.tsx</files>
  <action>
Update the press animation scale from 0.98 to 0.95 to match ANIM-01 requirement:

1. Find handlePressIn function (currently at line ~69-71):
   ```typescript
   const handlePressIn = () => {
     scale.value = withSpring(0.98, { damping: 20, stiffness: 300 });
   };
   ```

2. Change 0.98 to 0.95:
   ```typescript
   const handlePressIn = () => {
     scale.value = withSpring(0.95, { damping: 20, stiffness: 300 });
   };
   ```

WHY: ANIM-01 requirement specifies "Answer options scale to 0.95 on press, spring bounce back". Current implementation uses 0.98 which is too subtle.
  </action>
  <verify>
1. `bun run lint` passes
2. Manual test: Press and hold an option button - should visibly scale down to 0.95 (more noticeable than before)
3. Release - should spring back to 1.0 with bounce
4. Code inspection: grep for "0.95" in OptionButton.tsx confirms change
  </verify>
  <done>Option button press scale adjusted from 0.98 to 0.95 per ANIM-01 requirement</done>
</task>

<task type="auto">
  <name>Task 2: Add checkmark scale-in animation for correct answers</name>
  <files>apps/mobile/components/quiz/OptionButton.tsx</files>
  <action>
Add an animated checkmark that scales in when state becomes 'correct':

1. Create new shared value for checkmark animation:
   ```typescript
   const checkmarkScale = useSharedValue(0);
   ```

2. Add useEffect to trigger animation when state === 'correct':
   ```typescript
   useEffect(() => {
     if (state === 'correct') {
       checkmarkScale.value = withSpring(1, {
         damping: 12,
         stiffness: 200,
         overshootClamping: false, // Allow bounce
       });
     } else {
       checkmarkScale.value = 0; // Reset when not correct
     }
   }, [state, checkmarkScale]);
   ```

3. Create animated style for the checkmark icon:
   ```typescript
   const checkmarkAnimatedStyle = useAnimatedStyle(() => ({
     transform: [{ scale: checkmarkScale.value }],
     opacity: checkmarkScale.value,
   }));
   ```

4. Wrap the checkmark icon in renderIcon() with Animated.View:
   - Replace static View with Animated.View for the correct state icon
   - Apply checkmarkAnimatedStyle to the Animated.View
   - Keep the existing Ionicons checkmark-circle inside

5. Ensure incorrect icon (X) remains non-animated (shake is on the whole button)

The feel: When user gets answer right, the green checkmark should "pop" into view with a satisfying bounce (Duolingo's celebration moment).
  </action>
  <verify>
1. `bun run lint` passes
2. Manual test: Answer question correctly - checkmark scales in with bounce
3. Answer incorrectly - X appears instantly (no scale animation needed, shake is enough)
  </verify>
  <done>Correct answers show checkmark with satisfying scale-in bounce animation</done>
</task>

<task type="auto">
  <name>Task 3: Add progress bar pulse animation on correct answer</name>
  <files>apps/mobile/components/quiz/QuizHeader.tsx</files>
  <action>
Add a subtle pulse animation to the progress bar when the user answers correctly:

1. Add new prop to QuizHeader:
   ```typescript
   interface QuizHeaderProps {
     currentQuestion: number;
     totalQuestions: number;
     section: SectionCode;
     onClose: () => void;
     shouldPulse?: boolean; // New prop, triggers pulse when true
   }
   ```

2. Add shared value and effect for pulse:
   ```typescript
   const pulseScale = useSharedValue(1);

   useEffect(() => {
     if (shouldPulse) {
       // Quick scale up and back
       pulseScale.value = withSequence(
         withSpring(1.05, { damping: 15, stiffness: 400 }),
         withSpring(1, { damping: 15, stiffness: 400 })
       );
     }
   }, [shouldPulse, pulseScale]);
   ```

3. Create animated style:
   ```typescript
   const progressAnimatedStyle = useAnimatedStyle(() => ({
     transform: [{ scale: pulseScale.value }],
   }));
   ```

4. Wrap the progress bar container in Animated.View with the style:
   ```typescript
   <Animated.View style={[styles.progressContainer, progressAnimatedStyle]}>
     <ProgressBar ... />
   </Animated.View>
   ```

5. In quiz/index.tsx (already done in Task 1), pass shouldPulse prop:
   - Use the `lastAnswerCorrect` state from Task 1
   - Pass `shouldPulse={lastAnswerCorrect}` to QuizHeader

The feel: A subtle "yes!" moment when progress bar grows and pulses slightly. Green -> gold color shift is deferred to Phase 3 (streak gamification).
  </action>
  <verify>
1. `bun run lint` passes
2. Manual test: Answer correctly - progress bar has subtle pulse as it advances
3. Answer incorrectly - progress bar advances but no pulse
  </verify>
  <done>Progress bar pulses subtly on correct answers, enhancing satisfaction</done>
</task>

<task type="auto">
  <name>Task 4: Verify exit modal meets QUIZ-08 requirement</name>
  <files>apps/mobile/components/quiz/ExitModal.tsx, apps/mobile/app/quiz/index.tsx</files>
  <action>
Verify that the ExitModal component meets QUIZ-08 requirement ("Exit confirmation modal prevents accidental progress loss"):

1. Review ExitModal.tsx and quiz/index.tsx integration:
   - ExitModal is imported and rendered in quiz/index.tsx
   - showExitModal state controls visibility
   - handleClosePress sets showExitModal to true
   - handleExitCancel dismisses modal
   - handleExitConfirm exits quiz via router.back()

2. Verify modal content meets requirement:
   - Title: "Vill du avsluta?" (Swedish: "Do you want to quit?")
   - Message: "Din progress sparas inte om du avslutar nu." (Your progress won't be saved if you quit now)
   - Primary action (yellow): "Fortsätt öva" (Continue practicing) - calls onCancel
   - Destructive action (red text): "Avsluta" (Quit) - calls onConfirm

3. No code changes needed - this task verifies existing implementation.
   The ExitModal already:
   - Shows confirmation before exiting
   - Has clear messaging about progress loss
   - Makes "continue" the primary/easy action
   - Makes "quit" require deliberate secondary action

WHY this task exists: QUIZ-08 requirement was not explicitly verified in original plan. This ensures the feature is documented as verified.
  </action>
  <verify>
1. Code inspection: ExitModal.tsx exists with correct props (visible, onCancel, onConfirm)
2. Code inspection: quiz/index.tsx renders ExitModal with showExitModal state
3. Manual test: Tap X button in quiz - modal appears
4. Tap "Fortsätt öva" - modal closes, quiz continues
5. Tap X again, then "Avsluta" - exits quiz
6. Tap backdrop - modal closes (same as cancel)
  </verify>
  <done>Exit modal verified to meet QUIZ-08: prevents accidental progress loss with clear confirmation</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Lint check:** `cd apps/mobile && bun run lint` passes
2. **Build check:** App builds and runs without errors
3. **Store integration:** Kill app mid-quiz, reopen - resumes at same question
4. **Press animation:** Option buttons scale to 0.95 on press (ANIM-01)
5. **Checkmark animation:** Correct answer triggers bouncy checkmark scale-in
6. **Progress pulse:** Correct answer triggers subtle progress bar pulse
7. **Exit modal:** Prevents accidental exit with confirmation dialog (QUIZ-08)
8. **Haptics verified:** Light tap on selection, success haptic on correct, error haptic on incorrect
</verification>

<success_criteria>
- Quiz uses Zustand quizStore for state management
- Session persists across app restart (kill/reopen resumes)
- Option buttons scale to 0.95 on press with spring bounce back (ANIM-01)
- Checkmark animation bounces in on correct answer (spring with overshoot)
- Progress bar pulses subtly on correct answer
- Exit modal prevents accidental progress loss (QUIZ-08)
- All existing haptic feedback still works
- No TypeScript errors, lint passes
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-quiz-flow/02-01-SUMMARY.md`
</output>
