---
phase: 02-core-quiz-flow
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - apps/mobile/app/quiz/review.tsx
  - apps/mobile/app/quiz/summary.tsx
  - apps/mobile/app/quiz/_layout.tsx
autonomous: false

must_haves:
  truths:
    - "User can tap 'Granska fel' to see incorrect answers with explanations"
    - "Review screen shows each missed question with correct answer highlighted"
    - "User can return to summary or exit from review screen"
  artifacts:
    - path: "apps/mobile/app/quiz/review.tsx"
      provides: "Error review screen with explanations"
      min_lines: 80
    - path: "apps/mobile/app/quiz/summary.tsx"
      provides: "Navigation to review screen"
      contains: "router.push.*review"
  key_links:
    - from: "apps/mobile/app/quiz/summary.tsx"
      to: "apps/mobile/app/quiz/review.tsx"
      via: "router.push navigation"
      pattern: "router\\.push.*review"
---

<objective>
Create error review screen for learning from mistakes

Purpose: Help users understand their errors and learn the correct answers (growth mindset, gentle feedback)
Output: New review.tsx screen accessible from summary, showing wrong answers with explanations
</objective>

<execution_context>
@/Users/williamlarsten/.claude/get-shit-done/workflows/execute-plan.md
@/Users/williamlarsten/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-quiz-flow/02-CONTEXT.md
@.planning/phases/02-core-quiz-flow/02-RESEARCH.md
@.planning/phases/02-core-quiz-flow/02-01-SUMMARY.md

# Key files to reference
@apps/mobile/app/quiz/summary.tsx
@apps/mobile/app/quiz/_layout.tsx
@apps/mobile/constants/mock-questions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create error review screen</name>
  <files>apps/mobile/app/quiz/review.tsx</files>
  <action>
Create a new review.tsx screen that displays incorrect answers with explanations:

1. Create the file `apps/mobile/app/quiz/review.tsx`

2. Accept params for the review data:
   ```typescript
   const params = useLocalSearchParams<{
     section: SectionCode;
     incorrectAnswers: string; // JSON string of AnswerRecord[]
     questions: string; // JSON string of Question[]
   }>();
   ```

3. Parse and filter to get only incorrect answers with their questions:
   ```typescript
   const incorrectRecords = JSON.parse(params.incorrectAnswers || '[]');
   const allQuestions = JSON.parse(params.questions || '[]');

   // Match incorrect answers to their questions
   const reviewItems = incorrectRecords.map((record) => {
     const question = allQuestions.find(q => q.id === record.questionId);
     return { record, question };
   }).filter(item => item.question);
   ```

4. Render each incorrect question in a card:
   ```typescript
   {reviewItems.map((item, index) => (
     <Animated.View
       key={item.record.questionId}
       entering={FadeInDown.duration(400).delay(index * 100)}
     >
       <Card style={styles.reviewCard}>
         {/* Question number and section */}
         <View style={styles.questionHeader}>
           <Text variant="caption" color="secondary">
             Fråga {index + 1} av {reviewItems.length}
           </Text>
           <SectionPill section={item.question.section} />
         </View>

         {/* Question text */}
         <Text variant="body" style={styles.questionText}>
           {item.question.text}
         </Text>

         {/* User's answer (wrong) */}
         <View style={[styles.answerRow, styles.wrongAnswer]}>
           <Ionicons name="close-circle" size={20} color={colors.error} />
           <Text style={styles.answerLabel}>Ditt svar:</Text>
           <Text style={styles.answerText}>
             {item.question.options.find(o => o.label === item.record.selected)?.text}
           </Text>
         </View>

         {/* Correct answer */}
         <View style={[styles.answerRow, styles.correctAnswer]}>
           <Ionicons name="checkmark-circle" size={20} color={colors.success} />
           <Text style={styles.answerLabel}>Rätt svar:</Text>
           <Text style={styles.answerText}>
             {item.question.options.find(o => o.label === item.question.correctAnswer)?.text}
           </Text>
         </View>

         {/* Explanation */}
         <View style={styles.explanationContainer}>
           <Text variant="caption" color="secondary" style={styles.explanationLabel}>
             Förklaring:
           </Text>
           <Text variant="body" color="secondary">
             {item.question.explanation}
           </Text>
         </View>
       </Card>
     </Animated.View>
   ))}
   ```

5. Add header with back button and title:
   ```typescript
   <View style={styles.header}>
     <Pressable onPress={() => router.back()}>
       <Ionicons name="arrow-back" size={24} color={colors.text} />
     </Pressable>
     <Text variant="h3" style={styles.headerTitle}>
       Granska fel
     </Text>
     <View style={{ width: 24 }} /> {/* Spacer for centering */}
   </View>
   ```

6. Add bottom button to return:
   ```typescript
   <View style={styles.bottomBar}>
     <Button variant="primary" size="lg" fullWidth onPress={() => router.back()}>
       Tillbaka till resultat
     </Button>
   </View>
   ```

The tone should be encouraging - "This means you now know better what to focus on" - not punishing.
  </action>
  <verify>
1. `bun run lint` passes
2. File exists at apps/mobile/app/quiz/review.tsx
3. TypeScript compiles without errors
  </verify>
  <done>Review screen created with question, wrong answer, correct answer, and explanation for each missed question</done>
</task>

<task type="auto">
  <name>Task 2: Wire navigation from summary to review</name>
  <files>apps/mobile/app/quiz/summary.tsx</files>
  <action>
Update summary.tsx to navigate to review screen with correct data:

1. Get questions from quizStore (need to read before reset):
   ```typescript
   const { currentQuestions, resetSession } = useQuizStore();
   // Store questions in local state since we'll need them for review even after navigating
   const [sessionQuestions] = useState(currentQuestions);
   ```

2. Update handleReviewErrors to navigate with params:
   ```typescript
   const handleReviewErrors = () => {
     const incorrectAnswers = answers.filter(a => !a.correct);
     router.push({
       pathname: '/quiz/review',
       params: {
         section,
         incorrectAnswers: JSON.stringify(incorrectAnswers),
         questions: JSON.stringify(sessionQuestions),
       },
     });
   };
   ```

3. The "Granska fel" button already exists and calls handleReviewErrors - just need to implement the function properly (currently it just console.logs).

Important: Don't reset quizStore until user taps "Klar" - they may want to review errors first.
  </action>
  <verify>
1. `bun run lint` passes
2. Complete quiz with errors - tap "Granska fel" - navigates to review screen
3. Review screen shows the incorrect questions
  </verify>
  <done>Summary "Granska fel" button navigates to review screen with error data</done>
</task>

<task type="auto">
  <name>Task 3: Ensure review screen is in navigation stack</name>
  <files>apps/mobile/app/quiz/_layout.tsx</files>
  <action>
Verify the quiz layout includes the review screen in the stack:

1. Check current _layout.tsx - it likely already handles all files in the quiz/ folder automatically with expo-router's file-based routing

2. If explicit stack screens are defined, add review:
   ```typescript
   <Stack.Screen
     name="review"
     options={{
       headerShown: false,
       animation: 'slide_from_right',
     }}
   />
   ```

3. If using default file-based routing (no explicit Screen definitions), the review.tsx file will be picked up automatically. Just verify this works.

4. Test the navigation flow: quiz → summary → review → back to summary
  </action>
  <verify>
1. `bun run lint` passes
2. Navigation works: summary → review → back to summary
3. Swipe back gesture works on iOS
  </verify>
  <done>Review screen properly integrated in quiz navigation stack</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Lint check:** `cd apps/mobile && bun run lint` passes
2. **Review navigation:** Complete quiz with errors → tap "Granska fel" → see review screen
3. **Content display:** Review shows question text, user's wrong answer, correct answer, explanation
4. **Back navigation:** Can return to summary from review
5. **Quiz completion:** After review, can tap "Klar" on summary to exit
</verification>

<success_criteria>
- New review.tsx screen exists and displays incorrect answers
- Each review card shows: question, user's answer (marked wrong), correct answer (marked right), explanation
- Navigation from summary works with proper data passing
- Gentle, encouraging tone in UI text
- Staggered card animations for polish
- No TypeScript errors, lint passes
</success_criteria>

<checkpoint type="human-verify" gate="blocking">
  <what-built>Error review screen with question explanations and navigation from summary</what-built>
  <how-to-verify>
1. Run the app: `cd apps/mobile && npx expo run:ios`
2. Start a quiz session (navigate to Trana tab, select any section)
3. Answer some questions incorrectly (at least 2-3 wrong)
4. Complete the quiz to see summary
5. Tap "Granska fel (X)" button
6. Verify: Review screen shows each wrong answer with explanation
7. Tap "Tillbaka till resultat" - returns to summary
8. Tap "Klar" - exits quiz flow
  </how-to-verify>
  <resume-signal>Type "approved" if review screen works correctly, or describe issues</resume-signal>
</checkpoint>

<output>
After completion, create `.planning/phases/02-core-quiz-flow/02-03-SUMMARY.md`
</output>
