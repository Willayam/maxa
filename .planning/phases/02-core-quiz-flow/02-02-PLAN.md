---
phase: 02-core-quiz-flow
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - apps/mobile/app/quiz/summary.tsx
autonomous: true

must_haves:
  truths:
    - "Summary screen shows XP earned with animated count-up"
    - "Summary displays accuracy percentage and time stats"
    - "Completing quiz updates progressStore (XP, sessions, streak)"
    - "Stats appear with staggered fade-in animation (Duolingo-style)"
  artifacts:
    - path: "apps/mobile/app/quiz/summary.tsx"
      provides: "Enhanced summary with XP display and store integration"
      contains: "calculateSessionXP"
      contains: "useProgressStore"
  key_links:
    - from: "apps/mobile/app/quiz/summary.tsx"
      to: "apps/mobile/stores/progressStore.ts"
      via: "useProgressStore hook"
      pattern: "useProgressStore\\(\\)"
    - from: "apps/mobile/app/quiz/summary.tsx"
      to: "apps/mobile/constants/mock-questions.ts"
      via: "calculateSessionXP import"
      pattern: "calculateSessionXP"
---

<objective>
Enhance summary screen with XP calculation, progress persistence, and Duolingo-style celebration animations

Purpose: Make quiz completion feel rewarding with visible XP gains and satisfying stat reveals
Output: Summary screen that calculates XP, updates progress store, and displays stats with staggered animations
</objective>

<execution_context>
@/Users/williamlarsten/.claude/get-shit-done/workflows/execute-plan.md
@/Users/williamlarsten/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-quiz-flow/02-CONTEXT.md
@.planning/phases/02-core-quiz-flow/02-RESEARCH.md
@.planning/phases/02-core-quiz-flow/02-01-SUMMARY.md

# Key files to reference
@apps/mobile/app/quiz/summary.tsx
@apps/mobile/stores/progressStore.ts
@apps/mobile/constants/mock-questions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate XP calculation and progress store updates</name>
  <files>apps/mobile/app/quiz/summary.tsx</files>
  <action>
Add XP calculation and progress persistence to the summary screen:

1. Import required dependencies:
   ```typescript
   import { useProgressStore } from '@/stores/progressStore';
   import { useQuizStore } from '@/stores/quizStore';
   import { calculateSessionXP } from '@/constants/mock-questions';
   ```

2. Get progress store actions:
   ```typescript
   const { addXP, completeSession, updateStreak } = useProgressStore();
   const { resetSession } = useQuizStore();
   ```

3. Calculate XP earned from answers:
   ```typescript
   const xpEarned = calculateSessionXP(answers);
   ```

4. Add useEffect to update progress on mount (once per summary view):
   ```typescript
   const [hasUpdatedProgress, setHasUpdatedProgress] = useState(false);

   useEffect(() => {
     if (!hasUpdatedProgress && answers.length > 0) {
       // Update progress store
       addXP(xpEarned);
       completeSession(correctCount, totalQuestions);
       updateStreak();
       setHasUpdatedProgress(true);
     }
   }, [hasUpdatedProgress, answers.length, xpEarned, correctCount, totalQuestions]);
   ```

5. Reset quiz session on "Klar" button:
   ```typescript
   const handleDone = () => {
     resetSession(); // Clear quizStore
     router.dismissAll();
   };
   ```

WHY: Progress must persist so user sees their XP and streak grow. Session reset prevents stale data on next quiz.
  </action>
  <verify>
1. `bun run lint` passes
2. Complete a quiz session - check that progressStore.totalXP increased
3. Complete another session - sessionsCompleted should increment
  </verify>
  <done>Summary screen calculates XP and updates progressStore on completion</done>
</task>

<task type="auto">
  <name>Task 2: Add XP display card with celebration</name>
  <files>apps/mobile/app/quiz/summary.tsx</files>
  <action>
Add a prominent XP earned display with animation:

1. Create XP display card after the title section:
   ```typescript
   {/* XP Card - Duolingo-style celebration */}
   <Animated.View entering={FadeInDown.duration(500).delay(150)}>
     <Card style={styles.xpCard}>
       <View style={styles.xpContent}>
         <Text style={styles.xpIcon}>⚡</Text>
         <View style={styles.xpTextContainer}>
           <Text style={[styles.xpAmount, { color: colors.primary }]}>
             +{xpEarned}
           </Text>
           <Text variant="body" color="secondary">XP tjänat</Text>
         </View>
       </View>
     </Card>
   </Animated.View>
   ```

2. Add styles for XP card:
   ```typescript
   xpCard: {
     marginBottom: Spacing.lg,
     backgroundColor: colors.primaryLight, // Subtle gold/yellow tint
   },
   xpContent: {
     flexDirection: 'row',
     alignItems: 'center',
   },
   xpIcon: {
     fontSize: 40,
     marginRight: Spacing.md,
   },
   xpTextContainer: {
     flex: 1,
   },
   xpAmount: {
     fontSize: FontSize['3xl'],
     fontFamily: FontFamily.bold,
   },
   ```

3. Consider optional: Add a simple count-up animation for XP number (if time permits, use Reanimated text or increment state over ~1 second). Research indicates Duolingo uses instant display with emphasis animation rather than count-up, so instant is acceptable.

The feel: User immediately sees their XP reward prominently displayed with a celebratory icon.
  </action>
  <verify>
1. `bun run lint` passes
2. Complete quiz - XP card appears with earned amount prominently displayed
3. XP amount matches expected calculation (10 base + 2 per consecutive correct)
  </verify>
  <done>Summary shows XP earned with prominent, celebratory display</done>
</task>

<task type="auto">
  <name>Task 3: Enhance stat animations with Duolingo-style stagger</name>
  <files>apps/mobile/app/quiz/summary.tsx</files>
  <action>
Improve the existing animations to feel more Duolingo-like:

1. Update animation delays for better stagger effect:
   - Title: delay(0) - appears first
   - XP Card: delay(150)
   - Score Card: delay(300)
   - Stats Card: delay(450)
   - Bottom buttons: delay(600)

2. Add spring-based entering animation instead of just FadeInDown:
   ```typescript
   // Option A: Use springify for bouncier feel
   entering={FadeInDown.springify().damping(15).stiffness(150).delay(300)}

   // Option B: Keep simple fade if springify feels too bouncy
   entering={FadeInDown.duration(400).delay(300)}
   ```

3. Test and tune: The goal is a cascading reveal that feels celebratory but not slow. Total reveal should complete in ~800ms.

4. Add success haptic when summary first appears:
   ```typescript
   useEffect(() => {
     // Celebration haptic on mount
     Haptics.notificationAsync(Haptics.NotificationFeedbackType.Success);
   }, []);
   ```

The feel: Stats cascade in like Duolingo's lesson complete screen - celebratory but quick.
  </action>
  <verify>
1. `bun run lint` passes
2. Complete quiz - stats appear with satisfying staggered animation
3. Haptic feedback fires on summary screen appear
4. Animation completes within ~1 second (not too slow)
  </verify>
  <done>Summary stats cascade in with satisfying staggered animations and success haptic</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Lint check:** `cd apps/mobile && bun run lint` passes
2. **XP calculation:** Complete quiz with 7/10 correct - verify XP matches formula
3. **Progress persistence:** Check progressStore.totalXP increased by earned amount
4. **Session count:** progressStore.sessionsCompleted increments
5. **Streak update:** progressStore.currentStreak updates appropriately
6. **Animation timing:** Stats cascade in quickly (~800ms total)
7. **Haptic feedback:** Success haptic on summary appear
</verification>

<success_criteria>
- Summary displays XP earned prominently
- XP calculation uses streak bonus formula (10 base + 2 per consecutive)
- progressStore updated: totalXP, sessionsCompleted, streak
- quizStore reset when user taps "Klar"
- Staggered animations feel celebratory (Duolingo-style cascade)
- Success haptic fires on summary mount
- No TypeScript errors, lint passes
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-quiz-flow/02-02-SUMMARY.md`
</output>
