---
phase: 03-main-app-experience
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - apps/mobile/app/(tabs)/jag.tsx
  - apps/mobile/components/celebrations/StreakMilestone.tsx
  - apps/mobile/app/quiz/summary.tsx
autonomous: true

must_haves:
  truths:
    - "Jag tab shows real XP and streak from stores"
    - "Max coach displays contextual messages based on personality"
    - "Coach personality can be changed and persists"
    - "Streak milestones (3, 7, 30 days) trigger celebration"
    - "Quiz completion shows Max coach feedback message"
  artifacts:
    - path: "apps/mobile/app/(tabs)/jag.tsx"
      provides: "Profile tab with real state and Max coach integration"
    - path: "apps/mobile/components/celebrations/StreakMilestone.tsx"
      provides: "Celebration animation for streak milestones"
    - path: "apps/mobile/app/quiz/summary.tsx"
      provides: "Quiz summary with Max coach message"
  key_links:
    - from: "apps/mobile/app/(tabs)/jag.tsx"
      to: "apps/mobile/stores/coachStore.ts"
      via: "useCoachStore hook"
      pattern: "useCoachStore"
    - from: "apps/mobile/app/(tabs)/jag.tsx"
      to: "apps/mobile/stores/gamificationStore.ts"
      via: "useGamificationStore hook"
      pattern: "useGamificationStore"
---

<objective>
Connect Jag tab to real state, integrate Max coach with personality-based messages, and add streak milestone celebration animations to create a satisfying gamification feedback loop.

Purpose: Complete the gamification experience with coach integration and celebration moments
Output: Polished Jag tab with real progress data, functional Max coach, and streak celebrations
</objective>

<execution_context>
@/Users/williamlarsten/.claude/get-shit-done/workflows/execute-plan.md
@/Users/williamlarsten/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-main-app-experience/03-CONTEXT.md
@.planning/phases/03-main-app-experience/03-RESEARCH.md

# Prior plan outputs
@.planning/phases/03-main-app-experience/03-01-SUMMARY.md

# Current implementations
@apps/mobile/app/(tabs)/jag.tsx
@apps/mobile/app/quiz/summary.tsx
@apps/mobile/stores/coachStore.ts
@apps/mobile/stores/gamificationStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Connect Jag tab to real stores and update Max coach integration</name>
  <files>apps/mobile/app/(tabs)/jag.tsx</files>
  <action>
    Update Jag tab to use real state from stores instead of MOCK_USER.

    **Import and connect stores:**
    ```typescript
    import { useGamificationStore, useCoachStore, useProgressStore } from '@/stores';

    // In component:
    const {
      currentStreak,
      longestStreak,
      totalXP,
      level,
      xpForNextLevel,
      xpProgressInLevel,
    } = useGamificationStore();

    const { totalCorrect, totalAnswered, accuracyPercent } = useProgressStore();

    const { personality, setPersonality, getMessage } = useCoachStore();
    ```

    **Replace MOCK_USER references:**
    - `MOCK_USER.streak` -> `currentStreak`
    - `MOCK_USER.longestStreak` -> `longestStreak`
    - `MOCK_USER.totalQuestions` -> `totalAnswered`
    - `MOCK_USER.correctRate` -> `accuracyPercent()`
    - `MOCK_USER.coachStyle` -> `personality`

    **Keep mock data for non-connected fields:**
    ```typescript
    const USER_PROFILE = {
      name: 'Emma Andersson',
      email: 'emma@example.com',
      joinedDate: new Date('2024-11-15'),
      isPro: false,
      currentScore: 1.2, // HP score - needs real tracking
      goalScore: 1.8,
      sections: [...], // Weakness data - needs real tracking
    };
    ```

    **Update coach style selector to use store:**
    ```typescript
    const handleCoachStyleChange = (style: CoachPersonality) => {
      triggerImpact(Haptics.ImpactFeedbackStyle.Light);
      setPersonality(style);
    };
    ```

    Currently `coachStyle` is local useState. Change to:
    ```typescript
    // Remove: const [coachStyle, setCoachStyle] = useState<CoachStyle>(MOCK_USER.coachStyle);
    // Use store directly: personality, setPersonality
    ```

    **Add Max coach contextual message:**
    Show a dynamic message from Max based on current state:
    ```typescript
    const maxMessage = useMemo(() => {
      // Determine context based on current state
      if (currentStreak >= 7 && currentStreak % 7 === 0) {
        return getMessage({ type: 'streak_milestone', days: currentStreak });
      }
      return getMessage({ type: 'tab_visit', tab: 'Jag' });
    }, [currentStreak, getMessage]);
    ```

    Add message display in the coach card:
    ```typescript
    <Text variant="bodySm" color="secondary" style={styles.coachMessage}>
      {maxMessage}
    </Text>
    ```

    **Update stats grid with real data:**
    ```typescript
    <StatCard
      label="FrÃ¥gor"
      value={totalAnswered.toLocaleString()}
      icon="ðŸ“"
      ...
    />
    <StatCard
      label="Streak"
      value={`${currentStreak}d`}
      icon="ðŸ”¥"
      ...
    />
    <StatCard
      label="BÃ¤sta"
      value={`${longestStreak}d`}
      icon="ðŸ†"
      ...
    />
    <StatCard
      label="RÃ¤tt"
      value={`${accuracyPercent()}%`}
      icon="âœ“"
      ...
    />
    ```

    **Add XP level progress:**
    Add a level display near the profile:
    ```typescript
    <View style={styles.levelBadge}>
      <Text style={styles.levelText}>NivÃ¥ {level}</Text>
      <ProgressBar
        progress={(xpProgressInLevel() / xpForNextLevel()) * 100}
        size="sm"
      />
      <Text variant="caption" color="tertiary">
        {xpProgressInLevel()}/{xpForNextLevel()} XP
      </Text>
    </View>
    ```
  </action>
  <verify>
    TypeScript compiles: `cd apps/mobile && npx tsc --noEmit`
    App renders Jag tab without crash
    Coach personality selection persists across app restart
  </verify>
  <done>
    Jag tab connected to stores:
    - Real streak, XP, questions answered displayed
    - Coach personality selection uses coachStore
    - Max shows contextual message
    - Level progress displayed
  </done>
</task>

<task type="auto">
  <name>Task 2: Create streak milestone celebration component</name>
  <files>apps/mobile/components/celebrations/StreakMilestone.tsx</files>
  <action>
    Create a celebration animation component for streak milestones (3, 7, 30 days).

    **Create directory if needed:**
    ```bash
    mkdir -p apps/mobile/components/celebrations
    ```

    **Component implementation:**
    ```typescript
    import React, { useEffect } from 'react';
    import { View, StyleSheet, Modal } from 'react-native';
    import Animated, {
      useSharedValue,
      useAnimatedStyle,
      withSpring,
      withSequence,
      withDelay,
      withTiming,
      runOnJS,
    } from 'react-native-reanimated';
    import * as Haptics from 'expo-haptics';

    import { Text } from '@/components/ui/text';
    import { Button } from '@/components/ui/button';
    import { Colors, Spacing, BorderRadius, FontFamily, FontSize } from '@/constants/theme';
    import { useColorScheme } from '@/hooks/use-color-scheme';

    interface StreakMilestoneProps {
      visible: boolean;
      days: number;
      onDismiss: () => void;
    }

    export function StreakMilestone({ visible, days, onDismiss }: StreakMilestoneProps) {
      const colorScheme = useColorScheme() ?? 'light';
      const colors = Colors[colorScheme];

      const scale = useSharedValue(0);
      const opacity = useSharedValue(0);
      const fireScale = useSharedValue(0);
      const badgeScale = useSharedValue(0);

      useEffect(() => {
        if (visible) {
          // Staggered animation sequence (from RESEARCH.md)
          // 1. Haptic first
          Haptics.notificationAsync(Haptics.NotificationFeedbackType.Success);

          // 2. Backdrop fade in
          opacity.value = withTiming(1, { duration: 200 });

          // 3. Card scales in with spring
          scale.value = withDelay(
            100,
            withSpring(1, { damping: 12, stiffness: 200 })
          );

          // 4. Fire emoji bounces
          fireScale.value = withDelay(
            300,
            withSequence(
              withSpring(1.3, { damping: 8 }),
              withSpring(1, { damping: 12 })
            )
          );

          // 5. Badge scales in
          badgeScale.value = withDelay(
            500,
            withSpring(1, { damping: 15 })
          );
        } else {
          // Reset
          scale.value = 0;
          opacity.value = 0;
          fireScale.value = 0;
          badgeScale.value = 0;
        }
      }, [visible]);

      const backdropStyle = useAnimatedStyle(() => ({
        opacity: opacity.value,
      }));

      const cardStyle = useAnimatedStyle(() => ({
        transform: [{ scale: scale.value }],
      }));

      const fireStyle = useAnimatedStyle(() => ({
        transform: [{ scale: fireScale.value }],
      }));

      const badgeStyle = useAnimatedStyle(() => ({
        transform: [{ scale: badgeScale.value }],
      }));

      // Get milestone message
      const getMilestoneMessage = () => {
        if (days >= 30) return 'EN MÃ…NADS STREAK! ðŸ†';
        if (days >= 7) return 'EN VECKAS STREAK!';
        if (days >= 3) return 'TRE DAGAR I RAD!';
        return `${days} DAGAR!`;
      };

      const getSubtitle = () => {
        if (days >= 30) return 'Du har trÃ¤nat varje dag i en hel mÃ¥nad. Otroligt!';
        if (days >= 7) return 'Sju dagar i rad - du bygger en stark vana!';
        if (days >= 3) return 'Bra start! Tre dagar i rad visar pÃ¥ engagemang.';
        return 'FortsÃ¤tt sÃ¥ hÃ¤r!';
      };

      if (!visible) return null;

      return (
        <Modal transparent visible={visible} animationType="none">
          <Animated.View style={[styles.backdrop, { backgroundColor: colors.overlay }, backdropStyle]}>
            <Animated.View style={[styles.card, { backgroundColor: colors.cardBackground }, cardStyle]}>
              {/* Fire emoji with bounce */}
              <Animated.View style={[styles.fireContainer, fireStyle]}>
                <Text style={styles.fireEmoji}>ðŸ”¥</Text>
              </Animated.View>

              {/* Streak count badge */}
              <Animated.View style={[styles.streakBadge, { backgroundColor: colors.streak + '20' }, badgeStyle]}>
                <Text style={[styles.streakNumber, { color: colors.streak }]}>{days}</Text>
                <Text variant="caption" style={{ color: colors.streak }}>dagar</Text>
              </Animated.View>

              {/* Message */}
              <Text variant="h2" style={styles.title}>
                {getMilestoneMessage()}
              </Text>
              <Text variant="body" color="secondary" style={styles.subtitle}>
                {getSubtitle()}
              </Text>

              {/* Dismiss button */}
              <Button onPress={onDismiss} fullWidth size="lg">
                GRYM! ðŸŽ‰
              </Button>
            </Animated.View>
          </Animated.View>
        </Modal>
      );
    }

    const styles = StyleSheet.create({
      backdrop: {
        flex: 1,
        justifyContent: 'center',
        alignItems: 'center',
        padding: Spacing.xl,
      },
      card: {
        width: '100%',
        maxWidth: 340,
        borderRadius: BorderRadius['3xl'],
        padding: Spacing['2xl'],
        alignItems: 'center',
      },
      fireContainer: {
        marginBottom: Spacing.lg,
      },
      fireEmoji: {
        fontSize: 64,
      },
      streakBadge: {
        paddingHorizontal: Spacing.xl,
        paddingVertical: Spacing.md,
        borderRadius: BorderRadius.full,
        alignItems: 'center',
        marginBottom: Spacing.lg,
      },
      streakNumber: {
        fontSize: FontSize.hero,
        fontFamily: FontFamily.extrabold,
        lineHeight: FontSize.hero * 1.1,
      },
      title: {
        textAlign: 'center',
        marginBottom: Spacing.sm,
      },
      subtitle: {
        textAlign: 'center',
        marginBottom: Spacing.xl,
      },
    });
    ```
  </action>
  <verify>
    TypeScript compiles: `cd apps/mobile && npx tsc --noEmit`
    Component can be imported without error
  </verify>
  <done>
    StreakMilestone.tsx created with:
    - Staggered animation (haptic -> fade -> scale -> bounce)
    - Messages for 3, 7, 30 day milestones
    - Dismiss button with callback
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Max coach message to quiz summary screen</name>
  <files>apps/mobile/app/quiz/summary.tsx</files>
  <action>
    Update the quiz summary screen to show a Max coach feedback message.

    **Import coachStore:**
    ```typescript
    import { useCoachStore } from '@/stores';
    ```

    **Get coach message based on quiz results:**
    ```typescript
    const { getMessage } = useCoachStore();

    // Calculate quiz results (should already exist in component)
    const correctCount = answers.filter((a, i) => a === questions[i].correctAnswer).length;
    const totalQuestions = questions.length;

    const coachMessage = getMessage({
      type: 'quiz_complete',
      correct: correctCount,
      total: totalQuestions,
    });
    ```

    **Add Max coach card after the score display:**
    ```typescript
    {/* Max Coach Feedback */}
    <Animated.View entering={FadeInDown.duration(400).delay(600)}>
      <Card style={styles.coachCard}>
        <View style={styles.coachContent}>
          <View style={[styles.coachAvatar, { backgroundColor: colors.backgroundTertiary }]}>
            <Text style={styles.coachEmoji}>ðŸ¤–</Text>
          </View>
          <View style={styles.coachTextContent}>
            <View style={styles.coachNameRow}>
              <Text variant="h5">Max</Text>
              <View style={[styles.aiBadge, { backgroundColor: colors.primary }]}>
                <Text style={[styles.aiBadgeText, { color: colors.textOnPrimary }]}>AI</Text>
              </View>
            </View>
            <Text variant="bodySm" color="secondary">
              {coachMessage}
            </Text>
          </View>
        </View>
      </Card>
    </Animated.View>
    ```

    **Add styles for coach card:**
    ```typescript
    coachCard: {
      marginTop: Spacing.lg,
    },
    coachContent: {
      flexDirection: 'row',
      alignItems: 'center',
    },
    coachAvatar: {
      width: 48,
      height: 48,
      borderRadius: 24,
      alignItems: 'center',
      justifyContent: 'center',
      marginRight: Spacing.md,
    },
    coachEmoji: {
      fontSize: 24,
    },
    coachTextContent: {
      flex: 1,
    },
    coachNameRow: {
      flexDirection: 'row',
      alignItems: 'center',
      gap: Spacing.sm,
      marginBottom: Spacing.xxs,
    },
    aiBadge: {
      paddingHorizontal: Spacing.sm,
      paddingVertical: 2,
      borderRadius: BorderRadius.sm,
    },
    aiBadgeText: {
      fontSize: 10,
      fontFamily: FontFamily.bold,
    },
    ```

    **Check for streak milestone and show celebration:**
    If this quiz completion triggered a streak milestone, show the celebration:
    ```typescript
    import { StreakMilestone } from '@/components/celebrations/StreakMilestone';

    // In component
    const { currentStreak } = useGamificationStore();
    const [showStreakCelebration, setShowStreakCelebration] = useState(false);
    const streakMilestones = [3, 7, 14, 30, 60, 100];

    useEffect(() => {
      // Check if current streak is a milestone
      if (streakMilestones.includes(currentStreak)) {
        setShowStreakCelebration(true);
      }
    }, [currentStreak]);

    // In render:
    <StreakMilestone
      visible={showStreakCelebration}
      days={currentStreak}
      onDismiss={() => setShowStreakCelebration(false)}
    />
    ```
  </action>
  <verify>
    TypeScript compiles: `cd apps/mobile && npx tsc --noEmit`
    Quiz summary shows Max message
    Streak celebration appears on milestone days
  </verify>
  <done>
    Quiz summary enhanced with:
    - Max coach feedback message
    - Coach message reflects quiz performance
    - Streak milestone celebration triggers on appropriate days
  </done>
</task>

</tasks>

<verification>
1. Run TypeScript check: `cd apps/mobile && npx tsc --noEmit`
2. Run linter: `bun run lint`
3. Test on device/simulator:
   - Jag tab shows real stats from stores
   - Coach personality change persists
   - Quiz summary shows Max message
   - Complete quiz on day 3/7/30 to see streak celebration (or manually set streak)
</verification>

<success_criteria>
- Jag tab displays real XP, streak, questions answered from stores
- Coach personality selector updates coachStore and persists
- Max shows contextual message in Jag tab
- Quiz summary shows Max coach feedback based on performance
- Streak milestone celebration appears on 3, 7, 30 day streaks
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-main-app-experience/03-03-SUMMARY.md`
</output>
