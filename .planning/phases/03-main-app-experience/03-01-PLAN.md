---
phase: 03-main-app-experience
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/mobile/stores/gamificationStore.ts
  - apps/mobile/stores/coachStore.ts
  - apps/mobile/stores/index.ts
  - apps/mobile/package.json
autonomous: true

must_haves:
  truths:
    - "Streak tracks consecutive days with freeze protection"
    - "Daily goal progress persists and resets at midnight"
    - "XP leveling follows progressive curve with quick early wins"
    - "Max coach messages adapt to user's chosen personality style"
  artifacts:
    - path: "apps/mobile/stores/gamificationStore.ts"
      provides: "Streak, daily goals, XP leveling with MMKV persistence"
      exports: ["useGamificationStore"]
    - path: "apps/mobile/stores/coachStore.ts"
      provides: "Max coach personality messages for all contexts"
      exports: ["useCoachStore", "getCoachMessage"]
  key_links:
    - from: "apps/mobile/stores/gamificationStore.ts"
      to: "apps/mobile/stores/storage.ts"
      via: "MMKV persistence"
      pattern: "persist.*zustandStorage"
    - from: "apps/mobile/stores/coachStore.ts"
      to: "apps/mobile/stores/storage.ts"
      via: "MMKV persistence"
      pattern: "persist.*zustandStorage"
---

<objective>
Create the gamification state infrastructure with streak tracking (including freeze mechanics), daily goal management, progressive XP leveling, and Max coach personality-based message system.

Purpose: Foundation layer that all three tabs will connect to for displaying real gamification state
Output: Two new Zustand stores (gamificationStore, coachStore) with full MMKV persistence
</objective>

<execution_context>
@/Users/williamlarsten/.claude/get-shit-done/workflows/execute-plan.md
@/Users/williamlarsten/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-main-app-experience/03-RESEARCH.md

# Existing patterns to follow
@apps/mobile/stores/progressStore.ts
@apps/mobile/stores/storage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install date-fns for streak date logic</name>
  <files>apps/mobile/package.json</files>
  <action>
    Install date-fns for reliable date arithmetic (time zones, DST handling):

    ```bash
    cd apps/mobile && bun add date-fns
    ```

    Do NOT hand-roll date arithmetic. Use date-fns functions:
    - `differenceInCalendarDays` for streak calculations
    - `startOfDay` for day boundary comparisons
    - `format` for ISO date strings

    This follows the research guidance in 03-RESEARCH.md: "Time zones and DST are complex; use date-fns or day.js"
  </action>
  <verify>Run `bun --filter mobile list | grep date-fns` or check apps/mobile/package.json has date-fns</verify>
  <done>date-fns is installed in apps/mobile and available for import</done>
</task>

<task type="auto">
  <name>Task 2: Create gamificationStore with streak, daily goals, and XP leveling</name>
  <files>apps/mobile/stores/gamificationStore.ts</files>
  <action>
    Create the gamification store following the patterns in 03-RESEARCH.md.

    **State shape:**
    ```typescript
    interface GamificationState {
      // Streak tracking
      currentStreak: number;
      longestStreak: number;
      lastActivityDate: string | null; // YYYY-MM-DD format
      streakFreezes: number; // 0-2 max

      // Daily goals
      dailyGoal: number; // questions target (default 20)
      dailyProgress: number; // questions completed today
      lastProgressDate: string | null; // YYYY-MM-DD for daily reset

      // XP and leveling
      totalXP: number;
      level: number;

      // Actions
      checkAndUpdateStreak: () => void; // Call on app open
      recordActivity: () => void; // Call when completing a question
      addDailyProgress: (questions: number) => void;
      awardXP: (amount: number) => void;
      useStreakFreeze: () => boolean;
      awardStreakFreeze: () => void;

      // Computed getters
      xpForNextLevel: () => number;
      xpProgressInLevel: () => number;
      isDailyGoalComplete: () => boolean;
    }
    ```

    **Streak logic (from research):**
    - On app open: compare lastActivityDate with today using date-fns
    - Gap = 0 days (same day): no change
    - Gap = 1 day: normal continuation, increment streak
    - Gap = 2 days + has freeze: consume freeze, maintain streak
    - Gap > 2 days OR (gap = 2 + no freeze): reset streak to 0
    - Award freezes at 7-day and 30-day milestones (max 2 held)

    **Daily goal logic:**
    - Check lastProgressDate vs today on each dailyProgress access
    - If different day: reset dailyProgress to 0, update lastProgressDate
    - Default dailyGoal: 20 questions/day

    **XP leveling (polynomial curve from research):**
    ```typescript
    function xpRequiredForLevel(level: number): number {
      if (level <= 1) return 0;
      if (level <= 10) return level * 100; // Quick early wins
      if (level <= 30) return Math.floor(Math.pow(level, 1.5) * 50);
      return Math.floor(Math.pow(level, 2) * 30);
    }
    ```

    **Persist with MMKV** using the same pattern as progressStore:
    ```typescript
    import { persist, createJSONStorage } from 'zustand/middleware'
    import { zustandStorage } from './storage'

    export const useGamificationStore = create<GamificationState>()(
      persist(
        (set, get) => ({ ... }),
        {
          name: 'gamification-storage',
          storage: createJSONStorage(() => zustandStorage),
        }
      )
    )
    ```

    **Import date-fns for date calculations:**
    ```typescript
    import { differenceInCalendarDays, startOfDay, format } from 'date-fns'

    const getTodayString = () => format(new Date(), 'yyyy-MM-dd')
    ```
  </action>
  <verify>
    TypeScript compiles: `cd apps/mobile && npx tsc --noEmit`
    Store exports correctly: verify useGamificationStore can be imported
  </verify>
  <done>
    gamificationStore.ts exists with:
    - Streak tracking with freeze protection
    - Daily goal tracking with midnight reset
    - XP leveling with polynomial curve
    - Full MMKV persistence
  </done>
</task>

<task type="auto">
  <name>Task 3: Create coachStore with personality-based Max messages</name>
  <files>apps/mobile/stores/coachStore.ts, apps/mobile/stores/index.ts</files>
  <action>
    Create the Max coach store for personality-based contextual messages.

    **State shape:**
    ```typescript
    type CoachPersonality = 'Hype' | 'Lugn' | 'Strikt';

    type MessageContext =
      | { type: 'quiz_complete'; correct: number; total: number }
      | { type: 'streak_milestone'; days: number }
      | { type: 'streak_broken' }
      | { type: 'daily_goal_complete' }
      | { type: 'tab_visit'; tab: 'Idag' | 'Tr칛na' | 'Jag' };

    interface CoachState {
      personality: CoachPersonality;

      // Actions
      setPersonality: (personality: CoachPersonality) => void;
      getMessage: (context: MessageContext) => string;
    }
    ```

    **getMessage implementation (from research):**
    Focus on PROCESS not OUTCOME. Growth mindset for 16-25 age group.

    ```typescript
    getMessage: (context: MessageContext) => {
      const { personality } = get();

      if (context.type === 'quiz_complete') {
        const percent = Math.round((context.correct / context.total) * 100);

        if (personality === 'Hype') {
          if (percent >= 80) return `游꿀 ${context.correct}/${context.total} r칛tt! Du 칛r p친 g친ng!`;
          if (percent >= 50) return `Bra jobbat! ${context.correct}/${context.total} - forts칛tt s친! 游눩`;
          return `${context.correct}/${context.total} idag. Varje f칬rs칬k g칬r dig starkare! 游꺔`;
        }
        if (personality === 'Lugn') {
          if (percent >= 80) return `Riktigt bra. ${context.correct} av ${context.total} r칛tt visar p친 god f칬rst친else.`;
          if (percent >= 50) return `${context.correct}/${context.total} r칛tt. Bra att du tr칛nar regelbundet.`;
          return `${context.correct}/${context.total} idag. Fokusera p친 vad du l칛rt dig.`;
        }
        // Strikt
        if (percent >= 80) return `${context.correct}/${context.total}. Forts칛tt i denna takt f칬r att n친 ditt m친l.`;
        if (percent >= 50) return `${context.correct}/${context.total}. 칐ka tr칛ningen inom svaga omr친den.`;
        return `${context.correct}/${context.total}. Analysera misstaken och 칬va mer.`;
      }

      if (context.type === 'streak_milestone') {
        if (personality === 'Hype') return `GRYM JOBBAT! 游댠 ${context.days} dagar i rad - du 칛r oslagbar!`;
        if (personality === 'Lugn') return `Bra jobbat. ${context.days} dagar i rad visar p친 konsistens.`;
        return `${context.days} dagars streak. Forts칛tt s친 h칛r.`;
      }

      if (context.type === 'streak_broken') {
        if (personality === 'Hype') return `Ny dag, ny chans! L친t oss starta en 칛nnu l칛ngre streak 游눩`;
        if (personality === 'Lugn') return `Det h칛nder. Det viktiga 칛r att du forts칛tter tr칛na.`;
        return `Streak bruten. B칬rja om med b칛ttre konsistens.`;
      }

      if (context.type === 'daily_goal_complete') {
        if (personality === 'Hype') return `游꿢 DAGENS M칀L KLARAT! Du 칛r en maskin!`;
        if (personality === 'Lugn') return `Dagens m친l uppn친tt. Bra jobbat med konsistensen.`;
        return `Dagens m친l klarat. Sikta p친 samma imorgon.`;
      }

      // Tab visit messages
      if (context.type === 'tab_visit') {
        // Return encouraging message based on tab
        if (context.tab === 'Idag') {
          if (personality === 'Hype') return `Redo att krossa det idag? 游`;
          if (personality === 'Lugn') return `V칛lkommen tillbaka. L친t oss tr칛na.`;
          return `Dags att tr칛na. Fokus.`;
        }
        // ... etc
      }

      return '';
    }
    ```

    **Persist personality setting only:**
    ```typescript
    export const useCoachStore = create<CoachState>()(
      persist(
        (set, get) => ({ ... }),
        {
          name: 'coach-storage',
          storage: createJSONStorage(() => zustandStorage),
          partialize: (state) => ({ personality: state.personality }), // Only persist personality
        }
      )
    )
    ```

    **Update stores/index.ts** to export both new stores:
    ```typescript
    export { useGamificationStore } from './gamificationStore'
    export { useCoachStore } from './coachStore'
    ```
  </action>
  <verify>
    TypeScript compiles: `cd apps/mobile && npx tsc --noEmit`
    Both stores export correctly from @/stores
  </verify>
  <done>
    coachStore.ts exists with:
    - Personality setting (Hype/Lugn/Strikt)
    - getMessage function for all contexts
    - Growth mindset messaging
    - MMKV persistence for personality preference

    stores/index.ts updated to export both new stores
  </done>
</task>

</tasks>

<verification>
1. Run TypeScript check: `cd apps/mobile && npx tsc --noEmit`
2. Run linter: `bun run lint` from repo root
3. Verify stores can be imported: Create a test import in any existing file
4. App builds: `cd apps/mobile && npx expo run:ios` (if on Mac)
</verification>

<success_criteria>
- date-fns installed and available for import
- gamificationStore exports useGamificationStore with streak, daily goals, XP leveling
- coachStore exports useCoachStore with getMessage for all personality contexts
- Both stores persist to MMKV using established patterns
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-main-app-experience/03-01-SUMMARY.md`
</output>
