---
phase: 03-normering
plan: 03
type: execute
wave: 3
depends_on: ["03-01", "03-02"]
files_modified:
  - apps/web/src/app/hogskoleprovet/[slug]/page.tsx
autonomous: false

must_haves:
  truths:
    - "Test pages with normering data display the NormeringSection"
    - "Test pages without normering data do not show normering section"
    - "Normering section appears after file downloads, before related tests"
    - "Page loads normering data at build time (SSG)"
    - "JavaScript disabled shows table fallback correctly"
  artifacts:
    - path: "apps/web/src/app/hogskoleprovet/[slug]/page.tsx"
      provides: "Test detail page with normering integration"
      contains: "NormeringSection"
  key_links:
    - from: "apps/web/src/app/hogskoleprovet/[slug]/page.tsx"
      to: "apps/web/src/components/charts/normering-section.tsx"
      via: "imports and renders NormeringSection"
      pattern: "import.*NormeringSection"
    - from: "apps/web/src/app/hogskoleprovet/[slug]/page.tsx"
      to: "apps/web/src/lib/normering/loader.ts"
      via: "calls getNormeringData"
      pattern: "getNormeringData"
---

<objective>
Integrate the NormeringSection component into test detail pages. Load normering data at build time and conditionally render the section only for tests that have normering data available.

Purpose: Complete the normering feature by connecting components to the existing test pages. Users browsing hosten-2025 will see interactive normering charts.

Output: Updated test detail page with normering section integration.
</objective>

<execution_context>
@/Users/williamlarsten/.claude/get-shit-done/workflows/execute-plan.md
@/Users/williamlarsten/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-normering/03-CONTEXT.md
@.planning/phases/03-normering/03-01-SUMMARY.md
@.planning/phases/03-normering/03-02-SUMMARY.md
@apps/web/src/app/hogskoleprovet/[slug]/page.tsx

Key decisions from CONTEXT.md:
- Missing data: Hide normering section entirely on those pages (no placeholder)
- Static rendering for performance and SEO

Current page structure (from page.tsx):
- SiteHeader
- main content: back link, title, date, file sections (provpass, facit, normering PDFs, kallhanvisning)
- "Fler hogskoleprov" related tests section
- SiteFooter

Integration point: Add NormeringSection AFTER file sections, BEFORE related tests section.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add normering imports and data loading</name>
  <files>apps/web/src/app/hogskoleprovet/[slug]/page.tsx</files>
  <action>
Add imports for normering components and loader:

```typescript
// Add these imports at the top of the file
import { NormeringSection } from '@/components/charts/normering-section'
import { getNormeringData } from '@/lib/normering/loader'
```

In the TestPage component, load normering data:

```typescript
export default async function TestPage({ params }: PageProps) {
  const { slug } = await params;
  const test = getTestBySlug(slug);

  if (!test) {
    notFound();
  }

  // Load normering data (returns null if not available)
  const normeringData = await getNormeringData(slug);

  // ... rest of component
}
```

The getNormeringData function returns null for tests without normering JSON files, allowing conditional rendering.
  </action>
  <verify>TypeScript compiles: `cd apps/web && npx tsc --noEmit`</verify>
  <done>Imports added and normering data loading in TestPage component</done>
</task>

<task type="auto">
  <name>Task 2: Render NormeringSection conditionally in page layout</name>
  <files>apps/web/src/app/hogskoleprovet/[slug]/page.tsx</files>
  <action>
Add the NormeringSection component to the page, positioned after the file downloads and before the "Fler hogskoleprov" section.

Find the closing of the file sections div (after kallhanvisning) and add:

```typescript
{/* After the file sections, before "Fler hogskoleprov" */}
{normeringData && (
  <NormeringSection data={normeringData} />
)}
```

The placement should be:
1. File sections (provpass, facit, normering PDFs, kallhanvisning)
2. **NEW: Interactive Normering visualization** (only if data exists)
3. "Fler hogskoleprov" related tests section

This keeps PDF downloads accessible while adding the interactive visualization as an enhancement below.

Full integration example:
```tsx
{test.files.length === 0 ? (
  <div>...</div>
) : (
  <div className="space-y-8">
    {grouped.provpass.length > 0 && <FileSection ... />}
    {grouped.facit.length > 0 && <FileSection ... />}
    {grouped.normering.length > 0 && <FileSection ... />}
    {grouped.kallhanvisning.length > 0 && <FileSection ... />}
  </div>
)}

{/* Interactive normering visualization */}
{normeringData && (
  <NormeringSection data={normeringData} />
)}

<section className="mt-16 pt-8 border-t border-border">
  <h2 className="text-xl font-bold text-foreground mb-4">
    Fler hogskoleprov
  </h2>
  ...
</section>
```
  </action>
  <verify>TypeScript compiles: `cd apps/web && npx tsc --noEmit`</verify>
  <done>NormeringSection rendered conditionally after file sections</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Normering visualization integrated into test detail pages:
- hosten-2025 shows interactive histogram chart with bell curve
- Tabs switch between Total, Verbal, Kvantitativ views
- Tooltip shows HP-varde and percentile on hover
- Table fallback is visible (expand "Visa tabell" to see)
- Other test pages (without normering data) show no normering section
  </what-built>
  <how-to-verify>
1. Start the dev server: `cd apps/web && bun dev`
2. Visit http://localhost:3000/hogskoleprovet/hosten-2025
3. Verify:
   - Normering section appears with histogram bars and bell curve line
   - Three tabs visible: "Hela provet", "Verbal del", "Kvantitativ del"
   - Hover over bars shows tooltip with HP-varde and "Topp X%"
   - Click "Visa tabell" to expand the data table
   - Table shows HP-varde, Antal, Andel, Percentil columns
4. Visit http://localhost:3000/hogskoleprovet/hosten-2024
5. Verify: No normering section visible (this test has no normering data)
6. Test JavaScript disabled:
   - Open DevTools > Settings > Debugger > Disable JavaScript
   - Refresh hosten-2025 page
   - Verify: Table is visible (not collapsed), chart is hidden
   - Re-enable JavaScript
  </how-to-verify>
  <resume-signal>Type "approved" if visualization works correctly, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. TypeScript compiles: `cd apps/web && npx tsc --noEmit`
2. Build passes: `cd apps/web && bun run build`
3. Visual verification: hosten-2025 shows normering chart
4. Negative case: other tests don't show normering section
5. Accessibility: table visible when JS disabled
</verification>

<success_criteria>
- Test pages with normering data display interactive NormeringSection
- Test pages without normering data show no normering section (no placeholder)
- Chart displays histogram bars with bell curve overlay
- Tooltip shows HP-varde and percentile
- Table fallback works when JavaScript is disabled
- Tabs switch between Total/Verbal/Kvantitativ views
</success_criteria>

<output>
After completion, create `.planning/phases/03-normering/03-03-SUMMARY.md`
</output>
