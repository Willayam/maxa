---
phase: 03-normering
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - apps/web/src/components/ui/chart.tsx
  - apps/web/src/components/charts/normering-chart.tsx
  - apps/web/src/components/charts/normering-table.tsx
  - apps/web/src/components/charts/normering-section.tsx
  - apps/web/package.json
autonomous: true

must_haves:
  truths:
    - "Chart displays histogram bars with count per HP score"
    - "Bell curve line overlays the histogram"
    - "Tooltip shows HP-varde and Percentil (Topp X%)"
    - "Table fallback is visible when JavaScript is disabled"
    - "Tabs switch between Total, Verbal, and Kvantitativ views"
  artifacts:
    - path: "apps/web/src/components/charts/normering-chart.tsx"
      provides: "Interactive histogram chart with bell curve overlay"
      exports: ["NormeringChart"]
    - path: "apps/web/src/components/charts/normering-table.tsx"
      provides: "Accessible HTML table with normering data"
      exports: ["NormeringTable"]
    - path: "apps/web/src/components/charts/normering-section.tsx"
      provides: "Container component with tabs and JS detection"
      exports: ["NormeringSection"]
  key_links:
    - from: "apps/web/src/components/charts/normering-section.tsx"
      to: "apps/web/src/lib/normering/types.ts"
      via: "imports NormeringData type"
      pattern: "import.*NormeringData"
    - from: "apps/web/src/components/charts/normering-chart.tsx"
      to: "@/components/ui/chart"
      via: "uses shadcn chart primitives"
      pattern: "ChartContainer|ChartTooltip"
---

<objective>
Build the normering visualization components: interactive histogram chart with bell curve overlay, accessible HTML table fallback, and tabbed container with JavaScript detection.

Purpose: Create visually compelling and accessible normering visualizations that work for all users (with/without JavaScript, screen readers, bots).

Output: Three React components (NormeringChart, NormeringTable, NormeringSection) using shadcn/ui charts.
</objective>

<execution_context>
@/Users/williamlarsten/.claude/get-shit-done/workflows/execute-plan.md
@/Users/williamlarsten/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-normering/03-CONTEXT.md
@.planning/phases/03-normering/03-RESEARCH.md
@.planning/phases/03-normering/03-01-SUMMARY.md

Key decisions from CONTEXT.md:
- Chart type: Histogram bars + bell curve line overlay
- X-axis: HP-varde (0.0-2.0), Y-axis: count of people
- Tooltip: HP-varde + Percentil (e.g., "1.9 - Topp 5%")
- Colors: Primary amber/gold for bars, darker shade for curve
- Tabs: Total (default), VERB, KVANT breakdowns
- Table visible when JS disabled (progressive enhancement)
- Mobile: Tooltip positioned above chart to avoid obscuring data

Key patterns from RESEARCH.md:
- Use shadcn/ui charts (built on Recharts)
- ChartContainer, ChartTooltip, ChartTooltipContent primitives
- ComposedChart with Bar + Line
- ResponsiveContainer for responsive sizing
- type="monotone" for smooth bell curve interpolation
- min-h-[300px] md:min-h-[400px] for chart height
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install shadcn/ui charts and create chart primitives</name>
  <files>apps/web/src/components/ui/chart.tsx, apps/web/package.json</files>
  <action>
Install shadcn/ui chart component which includes Recharts:

```bash
cd apps/web && npx shadcn@latest add chart --yes
```

This will:
1. Add Recharts as a dependency
2. Create apps/web/src/components/ui/chart.tsx with ChartContainer, ChartTooltip, ChartTooltipContent, etc.

If shadcn CLI doesn't work in this environment, manually:
1. Add to package.json: `"recharts": "^2.12.0"`
2. Run `bun install` from repo root
3. Create chart.tsx with the primitives from shadcn/ui source

The chart.tsx should export:
- ChartContainer (wraps ResponsiveContainer with config)
- ChartTooltip (custom tooltip wrapper)
- ChartTooltipContent (default tooltip content)
- ChartConfig type
  </action>
  <verify>
1. Recharts in dependencies: `cat apps/web/package.json | jq '.dependencies.recharts'`
2. Chart component exists: `ls apps/web/src/components/ui/chart.tsx`
3. Install successful: `cd apps/web && bun install && bun run build` (or just TypeScript check)
  </verify>
  <done>shadcn/ui chart primitives installed with Recharts dependency</done>
</task>

<task type="auto">
  <name>Task 2: Create NormeringChart component (histogram + bell curve)</name>
  <files>apps/web/src/components/charts/normering-chart.tsx</files>
  <action>
Create the main chart component using Recharts ComposedChart:

```typescript
// apps/web/src/components/charts/normering-chart.tsx
'use client'

import { Bar, Line, ComposedChart, XAxis, YAxis, ResponsiveContainer, Tooltip } from 'recharts'
import type { NormeringDistribution } from '@/lib/normering/types'

interface NormeringChartProps {
  data: NormeringDistribution
}

export function NormeringChart({ data }: NormeringChartProps) {
  // Transform data for chart, calculate percentile from cumulative
  const chartData = data.distribution.map(row => ({
    hpScore: row.hpScore,
    count: row.count,
    percentile: Math.round(100 - row.cumulativePercentage),
  }))

  return (
    <div className="min-h-[300px] md:min-h-[400px] w-full">
      <ResponsiveContainer width="100%" height="100%">
        <ComposedChart data={chartData} margin={{ top: 20, right: 20, bottom: 60, left: 60 }}>
          <XAxis
            dataKey="hpScore"
            tickFormatter={(v) => v.toFixed(1)}
            label={{ value: 'HP-varde', position: 'insideBottom', offset: -10 }}
            domain={[0, 2.0]}
          />
          <YAxis
            label={{ value: 'Antal', angle: -90, position: 'insideLeft', offset: -10 }}
          />

          {/* Histogram bars */}
          <Bar
            dataKey="count"
            fill="hsl(var(--primary))"
            radius={[2, 2, 0, 0]}
            barSize={8}
          />

          {/* Bell curve line */}
          <Line
            dataKey="count"
            stroke="hsl(var(--primary-dark, var(--primary)))"
            strokeWidth={3}
            dot={false}
            type="monotone"
          />

          {/* Custom tooltip - positioned above on mobile */}
          <Tooltip
            content={({ active, payload }) => {
              if (!active || !payload?.[0]) return null
              const d = payload[0].payload
              return (
                <div className="bg-card-background border-2 border-border rounded-lg p-3 shadow-lg">
                  <p className="font-bold text-foreground text-lg">
                    {d.hpScore.toFixed(1)}
                  </p>
                  <p className="text-foreground-muted">
                    Topp {d.percentile}%
                  </p>
                </div>
              )
            }}
            position={{ y: 0 }}
            wrapperStyle={{ zIndex: 1000 }}
          />
        </ComposedChart>
      </ResponsiveContainer>
    </div>
  )
}
```

Key implementation details:
- Use ComposedChart to combine Bar and Line
- Calculate percentile as 100 - cumulativePercentage (for "Topp X%" format)
- Use theme CSS variables for colors (hsl(var(--primary)))
- type="monotone" for smooth bell curve interpolation
- Mobile-friendly tooltip positioning
  </action>
  <verify>TypeScript compiles: `cd apps/web && npx tsc --noEmit`</verify>
  <done>NormeringChart component exists with histogram bars and bell curve line overlay</done>
</task>

<task type="auto">
  <name>Task 3: Create NormeringTable component (accessible fallback)</name>
  <files>apps/web/src/components/charts/normering-table.tsx</files>
  <action>
Create an accessible HTML table that shows normering data:

```typescript
// apps/web/src/components/charts/normering-table.tsx
'use client'

import { useState } from 'react'
import type { NormeringDistribution } from '@/lib/normering/types'

interface NormeringTableProps {
  data: NormeringDistribution
  collapsible?: boolean
  defaultCollapsed?: boolean
}

export function NormeringTable({
  data,
  collapsible = false,
  defaultCollapsed = false
}: NormeringTableProps) {
  const [isCollapsed, setIsCollapsed] = useState(defaultCollapsed)

  return (
    <div className="border-2 border-border rounded-xl overflow-hidden">
      {collapsible && (
        <button
          onClick={() => setIsCollapsed(!isCollapsed)}
          className="w-full p-4 bg-card-background text-left font-semibold hover:bg-primary/5 transition-colors flex items-center justify-between"
          aria-expanded={!isCollapsed}
        >
          <span>{isCollapsed ? 'Visa tabell' : 'Dolj tabell'}</span>
          <span className="text-foreground-muted">{isCollapsed ? '+' : '-'}</span>
        </button>
      )}

      {!isCollapsed && (
        <div className="overflow-x-auto">
          <table className="w-full">
            <caption className="sr-only">
              Normeringstabell for hogskoleprovet - fordelning av HP-varden
            </caption>
            <thead>
              <tr className="bg-primary/5">
                <th scope="col" className="p-3 text-left font-semibold">HP-varde</th>
                <th scope="col" className="p-3 text-right font-semibold">Antal</th>
                <th scope="col" className="p-3 text-right font-semibold">Andel (%)</th>
                <th scope="col" className="p-3 text-right font-semibold">Percentil</th>
              </tr>
            </thead>
            <tbody>
              {data.distribution.map((row, index) => (
                <tr
                  key={row.hpScore}
                  className={index % 2 === 0 ? 'bg-card-background' : 'bg-background'}
                >
                  <td className="p-3 font-medium">{row.hpScore.toFixed(2)}</td>
                  <td className="p-3 text-right">{row.count.toLocaleString('sv-SE')}</td>
                  <td className="p-3 text-right">{row.percentage.toFixed(1)}%</td>
                  <td className="p-3 text-right">
                    Topp {Math.round(100 - row.cumulativePercentage)}%
                  </td>
                </tr>
              ))}
            </tbody>
            <tfoot>
              <tr className="bg-primary/5 font-semibold">
                <td className="p-3" colSpan={4}>
                  Medelvarde: {data.mean.toFixed(2)} |
                  Standardavvikelse: {data.stdDev.toFixed(2)} |
                  Deltagare: {data.totalParticipants.toLocaleString('sv-SE')}
                </td>
              </tr>
            </tfoot>
          </table>
        </div>
      )}
    </div>
  )
}
```

Key accessibility features:
- Semantic table markup (table, thead, tbody, tfoot)
- th with scope="col" for proper header association
- sr-only caption for screen readers
- Alternating row colors for readability
- Collapsible when JS enabled, visible by default when JS disabled
  </action>
  <verify>TypeScript compiles: `cd apps/web && npx tsc --noEmit`</verify>
  <done>NormeringTable component exists with accessible HTML table structure</done>
</task>

<task type="auto">
  <name>Task 4: Create NormeringSection container with tabs and JS detection</name>
  <files>apps/web/src/components/charts/normering-section.tsx</files>
  <action>
Create the container component that handles tabs and progressive enhancement:

```typescript
// apps/web/src/components/charts/normering-section.tsx
'use client'

import { useState, useEffect } from 'react'
import { NormeringChart } from './normering-chart'
import { NormeringTable } from './normering-table'
import type { NormeringData } from '@/lib/normering/types'

interface NormeringSectionProps {
  data: NormeringData
}

type TabId = 'total' | 'verbal' | 'kvantitativ'

export function NormeringSection({ data }: NormeringSectionProps) {
  const [activeTab, setActiveTab] = useState<TabId>('total')
  const [isJsEnabled, setIsJsEnabled] = useState(false)

  // Detect JavaScript availability for progressive enhancement
  useEffect(() => {
    setIsJsEnabled(true)
  }, [])

  // Determine which tabs to show (only if data exists)
  const tabs: { id: TabId; label: string }[] = [
    { id: 'total', label: 'Hela provet' },
  ]
  if (data.verbal) {
    tabs.push({ id: 'verbal', label: 'Verbal del' })
  }
  if (data.kvantitativ) {
    tabs.push({ id: 'kvantitativ', label: 'Kvantitativ del' })
  }

  // Get current distribution based on active tab
  const currentData = activeTab === 'total'
    ? data.total
    : activeTab === 'verbal'
      ? data.verbal
      : data.kvantitativ

  if (!currentData) return null

  return (
    <section className="mt-12">
      <h2 className="text-2xl font-bold text-foreground mb-4">Normering</h2>

      {/* Tabs - only show if multiple options */}
      {tabs.length > 1 && (
        <div className="flex gap-2 mb-6 flex-wrap">
          {tabs.map((tab) => (
            <button
              key={tab.id}
              onClick={() => setActiveTab(tab.id)}
              className={`px-4 py-2 rounded-lg font-semibold transition-colors ${
                activeTab === tab.id
                  ? 'bg-primary text-primary-foreground'
                  : 'bg-card-background border-2 border-border text-foreground hover:border-primary'
              }`}
            >
              {tab.label}
            </button>
          ))}
        </div>
      )}

      {/* Chart - only render when JavaScript is enabled */}
      {isJsEnabled && (
        <div className="mb-6">
          <NormeringChart data={currentData} />
        </div>
      )}

      {/* Table - always rendered, collapsible when JS enabled */}
      <NormeringTable
        data={currentData}
        collapsible={isJsEnabled}
        defaultCollapsed={isJsEnabled}
      />
    </section>
  )
}
```

Key features:
- Progressive enhancement: table visible by default, chart added when JS loads
- Conditional tabs: only show tabs if verbal/kvantitativ data exists
- Clean tab UI matching Maxa design (amber/gold primary, 2px borders)
- Mobile-friendly flex-wrap on tabs
  </action>
  <verify>TypeScript compiles: `cd apps/web && npx tsc --noEmit`</verify>
  <done>NormeringSection component exists with tabs and JavaScript detection for progressive enhancement</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. TypeScript compiles: `cd apps/web && npx tsc --noEmit`
2. Recharts installed: `cat apps/web/package.json | grep recharts`
3. All components exist:
   - apps/web/src/components/charts/normering-chart.tsx
   - apps/web/src/components/charts/normering-table.tsx
   - apps/web/src/components/charts/normering-section.tsx
4. Build passes: `cd apps/web && bun run build` (or lint check)
</verification>

<success_criteria>
- shadcn/ui chart primitives installed with Recharts
- NormeringChart renders histogram bars with bell curve line overlay
- NormeringTable provides accessible HTML table with proper ARIA
- NormeringSection container handles tabs and JS detection
- All components use theme CSS variables for consistent styling
</success_criteria>

<output>
After completion, create `.planning/phases/03-normering/03-02-SUMMARY.md`
</output>
