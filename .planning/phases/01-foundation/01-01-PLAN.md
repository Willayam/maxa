---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/mobile/package.json
  - apps/mobile/stores/storage.ts
  - apps/mobile/stores/quizStore.ts
  - apps/mobile/stores/progressStore.ts
  - apps/mobile/stores/index.ts
autonomous: true

must_haves:
  truths:
    - "App opens instantly with no loading flash (state reads are synchronous)"
    - "Quiz session survives app restart mid-session"
    - "Progress state (XP, streak) persists indefinitely"
  artifacts:
    - path: "apps/mobile/stores/storage.ts"
      provides: "MMKV instance and Zustand StateStorage adapter"
      exports: ["storage", "zustandStorage"]
    - path: "apps/mobile/stores/quizStore.ts"
      provides: "Active quiz session state with persist"
      exports: ["useQuizStore"]
    - path: "apps/mobile/stores/progressStore.ts"
      provides: "Cumulative progress state with persist"
      exports: ["useProgressStore"]
  key_links:
    - from: "apps/mobile/stores/quizStore.ts"
      to: "apps/mobile/stores/storage.ts"
      via: "persist middleware with zustandStorage"
      pattern: "createJSONStorage.*zustandStorage"
    - from: "apps/mobile/stores/progressStore.ts"
      to: "apps/mobile/stores/storage.ts"
      via: "persist middleware with zustandStorage"
      pattern: "createJSONStorage.*zustandStorage"
---

<objective>
Set up MMKV for synchronous local storage and Zustand stores with persist middleware.

Purpose: Enable instant app opens (no loading flash) and quiz state that survives app restart.
Output: Fully working stores (quizStore, progressStore) backed by MMKV persistence.
</objective>

<execution_context>
@/Users/williamlarsten/.claude/get-shit-done/workflows/execute-plan.md
@/Users/williamlarsten/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-RESEARCH.md

# Existing code to understand current patterns
@apps/mobile/package.json
@apps/mobile/app.json
@apps/mobile/constants/mock-questions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install MMKV and Zustand dependencies</name>
  <files>apps/mobile/package.json</files>
  <action>
Install required packages and run expo prebuild:

1. Install MMKV and its Nitro Modules dependency:
   ```bash
   cd apps/mobile && npx expo install react-native-mmkv react-native-nitro-modules
   ```

2. Install Zustand:
   ```bash
   cd apps/mobile && bun add zustand
   ```

3. Run expo prebuild to generate native projects (MMKV has native code):
   ```bash
   cd apps/mobile && npx expo prebuild
   ```

Note: After this, the app must use development builds (`npx expo run:ios` or `npx expo run:android`), not Expo Go.

The app.json already has `newArchEnabled: true` which is required for MMKV v4.
  </action>
  <verify>
    - `cat apps/mobile/package.json | grep react-native-mmkv` shows version ^4.x
    - `cat apps/mobile/package.json | grep zustand` shows version ^5.x
    - `ls apps/mobile/ios` and `ls apps/mobile/android` show native project directories exist
  </verify>
  <done>
    - react-native-mmkv ^4.x installed
    - react-native-nitro-modules installed
    - zustand ^5.x installed
    - Native projects generated via expo prebuild
  </done>
</task>

<task type="auto">
  <name>Task 2: Create MMKV storage adapter and Zustand stores</name>
  <files>
    apps/mobile/stores/storage.ts
    apps/mobile/stores/quizStore.ts
    apps/mobile/stores/progressStore.ts
    apps/mobile/stores/index.ts
  </files>
  <action>
Create the stores directory and files following patterns from RESEARCH.md:

**1. apps/mobile/stores/storage.ts**
Create MMKV instance and Zustand StateStorage adapter:
```typescript
import { StateStorage } from 'zustand/middleware'
import { createMMKV } from 'react-native-mmkv'

export const storage = createMMKV({ id: 'maxa-storage' })

export const zustandStorage: StateStorage = {
  setItem: (name, value) => storage.set(name, value),
  getItem: (name) => storage.getString(name) ?? null,
  removeItem: (name) => storage.remove(name),
}
```

**2. apps/mobile/stores/quizStore.ts**
Create quiz session store with persist:
- State: currentQuestionIndex, answers (AnswerRecord[]), sessionStartTime, currentQuestions (Question[]), section
- Actions: startSession(questions, section), submitAnswer(answer), nextQuestion(), endSession(), resetSession()
- Use types from `@/constants/mock-questions`
- Persist with `createJSONStorage(() => zustandStorage)`
- Storage name: 'quiz-session'

**3. apps/mobile/stores/progressStore.ts**
Create cumulative progress store with persist:
- State: totalXP (number), sessionsCompleted (number), currentStreak (number), lastSessionDate (string | null), totalCorrect (number), totalAnswered (number)
- Actions: addXP(amount), completeSession(correct, total), updateStreak()
- Default values: totalXP: 0, sessionsCompleted: 0, currentStreak: 0, lastSessionDate: null, totalCorrect: 0, totalAnswered: 0
- Include helper: accuracyPercent getter (totalCorrect / totalAnswered * 100, or 0 if no answers)
- Persist with `createJSONStorage(() => zustandStorage)`
- Storage name: 'progress-storage'

**4. apps/mobile/stores/index.ts**
Re-export all stores:
```typescript
export { storage, zustandStorage } from './storage'
export { useQuizStore } from './quizStore'
export { useProgressStore } from './progressStore'
```

Use TypeScript types from `@/constants/mock-questions` for Question, AnswerRecord, SectionCode.
  </action>
  <verify>
    - `ls apps/mobile/stores/` shows storage.ts, quizStore.ts, progressStore.ts, index.ts
    - `cd apps/mobile && bun run typecheck` passes with no errors
    - Files use `createJSONStorage(() => zustandStorage)` pattern (not raw zustandStorage)
  </verify>
  <done>
    - storage.ts exports MMKV instance and Zustand-compatible adapter
    - quizStore.ts exports useQuizStore with session state and actions
    - progressStore.ts exports useProgressStore with cumulative stats and XP tracking
    - All files pass TypeScript checks
    - Stores use persist middleware correctly
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify stores work in isolation</name>
  <files>apps/mobile/app/(tabs)/index.tsx</files>
  <action>
Temporarily add store usage to index.tsx to verify the stores load synchronously:

1. Import the stores at the top:
   ```typescript
   import { useProgressStore } from '@/stores'
   ```

2. Inside IdagScreen component, add a single line to read from the store:
   ```typescript
   const totalXP = useProgressStore((state) => state.totalXP)
   ```

3. Add XP display somewhere visible (e.g., in the greeting area):
   ```typescript
   <Text variant="caption" color="tertiary">{totalXP} XP</Text>
   ```

This is a smoke test to ensure:
- MMKV loads synchronously (no flash)
- Zustand store hydrates from MMKV on app start
- The store can be read from a component

Note: This is minimal integration to prove the stores work. Full integration with quiz screens is Phase 2.
  </action>
  <verify>
    - `cd apps/mobile && bun run typecheck` passes
    - App builds successfully: `cd apps/mobile && npx expo run:ios --no-build-cache` (or use simulator)
    - On app open, XP displays immediately (no loading flash or "undefined")
  </verify>
  <done>
    - Store imported and used in at least one component
    - TypeScript compiles without errors
    - App opens with store value visible (proves synchronous hydration)
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. `cd apps/mobile && bun run typecheck` - No TypeScript errors
2. `ls apps/mobile/stores/` - All 4 files exist
3. `grep -r "createJSONStorage" apps/mobile/stores/` - Both stores use correct persist pattern
4. App opens instantly with no loading flash (manual check on device/simulator)
</verification>

<success_criteria>
- MMKV and Zustand installed and working
- quizStore manages session state (questions, answers, index)
- progressStore manages cumulative state (XP, streak, accuracy)
- Both stores persist to MMKV and survive app restart
- App opens instantly with no loading flash (synchronous reads)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
